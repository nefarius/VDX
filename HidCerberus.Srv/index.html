<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>HidGuardian Configuration</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.2.1/jquery.form.min.js"
            integrity="sha384-tIwI8+qJdZBtYYCKwRkjxBGQVZS3gGozr3CtI+5JF/oL1JmPEHzCEnIKbDbLTCer"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
          crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"
            integrity="sha384-/EjRuG6YTb6zCFou+DBnYCi5u9E1RjUMJanyGOL7DUYLp6wSCUuHNhd58uoGj7jh"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout.mapping/2.4.1/knockout.mapping.min.js"
            integrity="sha384-5iaafnDCmIZLLNfCHYJwy/FQZf6AXVLgSx8wPvUvkOOOFk7ODxEXwdfxgHW3dv4a"
            crossorigin="anonymous"></script>

    <script>
        /* Publish list of affected devices */
        $.getJSON("/v1/hidguardian/affected/get", function (data) {
            var items = [];
            $.each(data, function (key, val) {
                items.push('<li class="list-group-item">'
                    + val
                    + '<span class="pull-right"><button type="button" class="affected-remove btn btn-primary btn-xs">Remove</button></span></li>');
            });

            if (items.length === 0) {
                $("#purge-affected-devices").hide();
            }

            $("<ul/>", {
                "class": "list-group",
                html: items.join("")
            }).prependTo("#affected-devices");
        });

        /* Publish list of whitelisted PIDs */
        $.getJSON("/v1/hidguardian/whitelist/get", function (data) {
            var items = [];
            $.each(data, function (key, val) {
                items.push('<li class="list-group-item">'
                    + val
                    + '<span class="pull-right"><button type="button" class="whitelist-remove btn btn-primary btn-xs">Remove</button></span></li>');
            });

            if (items.length === 0) {
                $("#purge-whitelisted-pids").hide();
            }

            $("<ul/>", {
                "class": "list-group",
                html: items.join("")
            }).prependTo("#whitelisted-pids");
        });

        /* Submit forms via AJAX */
        $(function () {
            $('#add-affected-devices').ajaxForm(function () {
                location.reload();
            });
        });

        /* Purge affected devices */
        $(document).on("click", "#purge-affected-devices", function () {
            $.get("/v1/hidguardian/affected/purge", function (data, status) {
                location.reload();
            });
        });

        /* Purge affected devices */
        $(document).on("click", "#purge-whitelisted-pids", function () {
            $.get("/v1/hidguardian/whitelist/purge", function (data, status) {
                location.reload();
            });
        });

        /* Click handler for individual affected remove button  */
        $(document).on("click", ".affected-remove", function () {
            $.post("/v1/hidguardian/affected/remove", {
                hwids: $(this).closest('li').clone().children().remove().end().text()
            })
                .done(function (data) {
                    location.reload();
                });
        });

        /* Click handler for individual whitelist remove button  */
        $(document).on("click", ".whitelist-remove", function () {
            $.get("/v1/hidguardian/whitelist/remove/"
                + $(this).closest('li').clone().children().remove().end().text(), function (data, status) {
                    location.reload();
                });
        });
    </script>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <h1>HidGuardian Configuration</h1>
        <p>Heya, you've found the HidCerberus Service configuration page.</p>
        <p>Here you can change settings affecting HidGuardian and view what's going on under the hood.</p>

        <!-- List affected devices -->
        <div class="panel panel-default">
            <div class="panel-heading">Currently affected devices</div>
            <div class="panel-body" id="affected-devices">
                <p>
                    <span class="pull-right">
                        <button id="purge-affected-devices" type="submit" class="btn btn-danger btn-sm">Remove all</button>
                    </span>
                </p>
            </div>
        </div>

        <!-- List available devices -->
        <div class="panel panel-default">
            <div class="panel-heading">Available USB/Bluetooth/HID devices</div>
            <div class="panel-body" id="available-devices">
                <ul class="list-group" data-bind="foreach: hidDevices">
                    <li class="list-group-item">
                        <h4 class="list-group-item-heading">
                            <span data-bind="text: manufacturer"></span>
                            <span data-bind="if: (!manufacturer)">Unknown</span>
                            <span data-bind="text: productName"></span>
                            <span data-bind="if: (!productName)">Unknown</span>
                            <span class="pull-right"><button type="button" class="available-hide btn btn-success btn-xs">Hide</button></span>
                        </h4>
                        <p class="list-group-item-text">
                            <span class="label label-default" data-bind="text: hardwareId"></span>
                        </p>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Add affected devices -->
        <div class="panel panel-default">
            <div class="panel-heading">Add affected devices</div>
            <div class="panel-body">
                <form id="add-affected-devices" method="post" action="/v1/hidguardian/affected/add">
                    <div class="form-group">
                        <label for="hwids">Enter Hardware IDs below (one line per ID)</label>
                        <textarea class="form-control" name="hwids" id="hwids" rows="5"
                                  placeholder="HID\VID_0079&amp;PID_0011&amp;REV_0106&#10;HID\{00001124-0000-1000-8000-00805f9b34fb}_VID&amp;0002054c_PID&amp;05c4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>

        <!-- List whitelisted PIDs -->
        <div class="panel panel-default">
            <div class="panel-heading">Currently whitelisted process IDs</div>
            <div class="panel-body" id="whitelisted-pids">
                <p>
                    <span class="pull-right">
                        <button id="purge-whitelisted-pids" type="submit" class="btn btn-danger btn-sm">Remove all</button>
                    </span>
                </p>
            </div>
        </div>
    </div>

    <script>
        /* Publish list of available devices */
        $.getJSON("/v1/hid/devices/get", function (data) {
            function HidDevicesViewModel() {
                var self = this;
                self.hidDevices = ko.observableArray(data);
            }
            ko.applyBindings(new HidDevicesViewModel());
        });
    </script>
</body>
</html>